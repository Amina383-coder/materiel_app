<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Signalisation d'incident informatique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/historique.css') }}" />
    <style>
        .incident-card { padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.06); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .form-input, .form-select, textarea { width: 100%; padding: 10px; border: 1px solid #e5e7eb; border-radius: 8px; }
        .section-title { margin: 0 0 10px; }
        .checkbox-group { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
        .button-group { display: flex; gap: 10px; justify-content: flex-end; margin-top: 16px; }
        .btn { padding: 10px 16px; border: 0; border-radius: 8px; cursor: pointer; }
        .btn-primary { background: #2563eb; color: #fff; }
        .btn-secondary { background: #e5e7eb; }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}" />
</head>

<body>
    <div class="container">
        <header>
            <h1>
                <img src="{{ url_for('static', filename='images/Logo_sedima.png') }}" alt="Logo gestion matériel IT" width="120">                Gestion Matériel IT
            </h1>
            <p>Système de suivi des incidents, attributions et restitutions</p>
        </header>

        <div class="main-card incident-card">
            <div class="nav-tabs">
                <a href="{{ url_for('main.attribution') }}" class="tab-button" aria-label="Aller à l'attribution" tabindex="0"><i class="fas fa-laptop"></i>Attribution</a>
                <a href="{{ url_for('main.restitution') }}" class="tab-button" aria-label="Aller à la restitution" tabindex="0"><i class="fas fa-undo"></i>Restitution</a>
                <a href="{{ url_for('main.incident') }}" class="tab-button active" aria-label="Aller à l'incidence" tabindex="0"><i class="fas fa-triangle-exclamation"></i>Incidence</a>
                <a href="{{ url_for('main.historique') }}" class="tab-button" aria-label="Voir l'historique" tabindex="0"><i class="fas fa-history"></i>Historique</a>
            </div>

            <form id="form-incident">
                <h2 class="section-title">FORMULAIRE DE SIGNALISATION D'INCIDENT</h2>
                <h3 class="form-section-title">Numéro de fiche</h3>
                <div class="grid-3">
                    <input class="form-input" id="incident-numero-fiche" readonly placeholder="Généré automatiquement après enregistrement" />
                    <input class="form-input" type="date" name="date_incident" placeholder="Date incident" />
                    <div></div>
                </div>
                <div class="grid-2" style="margin-top:12px;">
                    <h3 class="form-section-title" style="grid-column: 1 / -1;">Déclarant</h3>
                    <input class="form-input" name="declarant_nom" placeholder="Nom / Prénom" required />
                    <input class="form-input" name="telephone" placeholder="Téléphone" required />
                </div>
                <div class="grid-2" style="margin-top:12px;">
                    <input class="form-input" name="email" placeholder="Email" type="email" pattern="^[^@\s]+@[^@\s]+\.[^@\s]+$" />
                    <select name="service" class="form-select" required>
                            <option value="">Sélectionner le service...</option>
                            <option value="Direction générale">Direction générale</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Contrôle de gestion">Contrôle de gestion</option>
                            <option value="Finance et comptabilité">Finance et comptabilité</option>
                            <option value="Performance">Performance</option>
                            <option value="Supply chain">Supply chain</option>
                            <option value="QHSE">QHSE</option>
                            <option value="Technique">Technique</option>
                            <option value="Industrie">Industrie</option>
                            <option value="Informatique">Informatique</option>
                            <option value="Juridique">Juridique</option>
                                        <option value="Commercial">Marketing et commercial</option>
                    </select>
                </div>

                <h3 class="form-section-title" style="margin-top:16px;">Matériel touché par l'incident</h3>
                <div class="form-group">
                    <select name="materiel_touche" class="form-select" required>
                        <option value="">Sélectionner...</option>
                                                    <option value="ordinateur_portable">Ordinateur portable</option>
                                                    <option value="ordinateur_bureau">Ordinateur de bureau</option>
                                                    <option value="telephone">Téléphone IP</option>
                                                    <option value="smartphone">Smartphone</option>
                                                    <option value="cartouche">Cartouche</option>
                                                    <option value="imprimantes">Imprimantes</option>
                                                    <option value="accessoires">Accessoires</option>
                                                    <option value="ecran">Écran</option>
                    </select>
                </div>

                <h3 class="form-section-title" style="margin-top:16px;">Numéro de série du matériel</h3>
                <input class="form-input" name="numero_serie_actif" placeholder="Numéro de série du matériel touché" />

                <h3 class="form-section-title" style="margin-top:16px;">Nature de l'incident</h3>
                <div class="checkbox-group">
                    <label><input type="checkbox" name="natures" value="perte_service"> Perte de service ou de fonctionnalités</label>
                    <label><input type="checkbox" name="natures" value="erreur_saisie"> Erreur pendant le processus de saisie</label>
                    <label><input type="checkbox" name="natures" value="mauvais_fonct_logiciel"> Mauvais fonctionnement d'un logiciel</label>
                    <label><input type="checkbox" name="natures" value="accident_electrique"> Accident de nature électrique</label>
                    <label><input type="checkbox" name="natures" value="vol_ordinateur"> Vol d'un ordinateur portable</label>
                    <label><input type="checkbox" name="natures" value="mauvais_fonct_materiel"> Mauvais fonctionnement du matériel</label>
                    <label><input type="checkbox" name="natures" value="degradation_performance"> Dégradation de performance</label>
                    <label><input type="checkbox" name="natures" value="virus"> Détection d'un virus</label>
                    <label><input type="checkbox" name="natures" value="autre"> Autre</label>
                </div>

                <h3 class="form-section-title" style="margin-top:16px;">Autres informations complémentaires</h3>
                <textarea rows="4" name="autres_infos" placeholder="Décrivez l'incident"></textarea>

                <h3 class="form-section-title" style="margin-top:16px;">Signature </h3>
                <canvas id="incident-signature" width="500" height="160" style="border:1px solid #e5e7eb;border-radius:8px;background:#fff;max-width:100%;"></canvas>
                <div class="button-group" style="justify-content:flex-start;margin-top:8px;">
                    <button type="button" class="btn btn-secondary" id="clear-incident-signature"><i class="fas fa-eraser"></i>Effacer</button>
                </div>

                <div class="button-group">
                    <button type="reset" class="btn btn-secondary">Annuler</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Envoyer</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api';
        
        function generateNumeroFiche(prefix) {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            const d = String(now.getDate()).padStart(2, '0');
            const h = String(now.getHours()).padStart(2, '0');
            const i = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            return `${prefix}-${y}${m}${d}-${h}${i}${s}`;
        }
        
        function collectChecked(name) {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(x => x.value);
        }

        // Signature canvas (optionnelle)
        function makeSignaturePad(canvasId, clearBtnId) {
            const canvas = document.getElementById(canvasId);
            const clearBtn = document.getElementById(clearBtnId);
            const ctx = canvas.getContext('2d');
            let drawing = false;
            let hasStroke = false;
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const start = (e) => { drawing = true; hasStroke = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
            const move = (e) => { if (!drawing) return; const p = getPos(e); ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.strokeStyle = '#111827'; ctx.lineTo(p.x, p.y); ctx.stroke(); };
            const end = () => { drawing = false; };
            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', move);
            window.addEventListener('mouseup', end);
            canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e); });
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e); });
            canvas.addEventListener('touchend', (e) => { e.preventDefault(); end(); });
            clearBtn.addEventListener('click', () => { ctx.clearRect(0, 0, canvas.width, canvas.height); hasStroke = false; });
            return { has: () => hasStroke, toDataURL: () => canvas.toDataURL('image/png') };
        }

        let incidentPad;
        document.addEventListener('DOMContentLoaded', () => {
            // Générer et afficher le numéro de fiche incident
            const numeroFiche = generateNumeroFiche('ICD');
            const numInput = document.getElementById('incident-numero-fiche');
            if (numInput) numInput.value = numeroFiche;
            incidentPad = makeSignaturePad('incident-signature', 'clear-incident-signature');
        });

        document.getElementById('form-incident').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const pngBase64 = incidentPad && incidentPad.has() ? incidentPad.toDataURL() : null;
            const data = {
                numero_fiche: document.getElementById('incident-numero-fiche').value,
                date_incident: form.get('date_incident') || null,
                declarant_nom: form.get('declarant_nom') || '',
                telephone: form.get('telephone') || '',
                email: form.get('email') || null,
                service: form.get('service') || null,
                numero_serie_actif: form.get('numero_serie_actif') || null,
                materiel_touche: form.get('materiel_touche') || null,
                natures: collectChecked('natures'),
                autres_infos: form.get('autres_infos') || null,
                signature_png: pngBase64
            };
            try {
                const res = await fetch(`${API_BASE}/incidents`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                const result = await res.json();
                if (result.success) {
                    alert('Incident enregistré avec succès ! Redirection vers l\'historique...');
                    
                    // Afficher le numéro de fiche généré
                    if (result.numero_fiche) {
                        document.getElementById('incident-numero-fiche').value = result.numero_fiche;
                    }
                    
                    // Redirection automatique vers l'historique après 2 secondes
                    setTimeout(() => {
                        window.location.href = "{{ url_for('main.historique') }}";
                    }, 2000);
                    
                    e.target.reset();
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (err) {
                console.error(err);
                alert('Erreur réseau');
            }
        });
    </script>
</body>

</html>


